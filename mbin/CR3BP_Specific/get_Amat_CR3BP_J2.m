function [A] = get_Amat_CR3BP_J2(mu, r_n, J2p, J2s, Rp, Rs, n)
%%% Description
%       Returns the A-matrix for the modified CR3BP with J2 for both the
%       primary and secondary bodies
%       
% --------------------------------------------------------------
%%% Inputs
%       mu  - [1x1] Mass ratio of CR3BP system
%       r_n - [3x1] Normalized position vector to evaluate dynamics at
%       J2p - [1x1] J2 value of primary body
%       J2s - [1x1] J2 value of secondary body
%       Rp  - [1x1] Normalized radius of primary body
%       Rs  - [1x1] Normalized radius of secondary body
%       n   - [1x1] Normalized mean motion of system
% --------------------------------------------------------------
%%% Outputs
%       A - [6x6] A matrix for the modified CR3BP (Jacobian of state wrt dynamics)
% --------------------------------------------------------------
%%% Author
%       Luke Bury, luke.bury@colorado.edu
% ===============================================================
% ------------------------------------
%%% Unpack position
% ------------------------------------
x = r_n(1);
y = r_n(2);
z = r_n(3);

% ------------------------------------
%%% Calculate A Matrix
% ------------------------------------
% %%% Full A matrix
% A = zeros(6,6);
% A(1:3,4:6) = eye(3);
% A(4,5) = 2;
% A(5,4) = -2;
% A(4,1) = (mu + x - 1)*((3*mu*(2*mu + 2*x - 2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(5/2)) - (3*J2s*Rs^2*mu*(2*mu + 2*x - 2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(7/2)) + (21*J2s*Rs^2*mu*(2*mu + 2*x - 2)*((mu + x - 1)^2 + y^2 - 4*z^2))/(4*((mu + x - 1)^2 + y^2 + z^2)^(9/2))) + (mu - 1)/((mu + x)^2 + y^2 + z^2)^(3/2) - (mu + x)*((3*(2*mu + 2*x)*(mu - 1))/(2*((mu + x)^2 + y^2 + z^2)^(5/2)) - (J2p*Rp^2*(2*mu + 2*x)*(3*mu - 3))/(2*((mu + x)^2 + y^2 + z^2)^(7/2)) + (7*J2p*Rp^2*(2*mu + 2*x)*(3*mu - 3)*((mu + x)^2 + y^2 - 4*z^2))/(4*((mu + x)^2 + y^2 + z^2)^(9/2))) - mu/((mu + x - 1)^2 + y^2 + z^2)^(3/2) - (3*J2s*Rs^2*mu*((mu + x - 1)^2 + y^2 - 4*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(7/2)) + (J2p*Rp^2*(3*mu - 3)*((mu + x)^2 + y^2 - 4*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(7/2)) + n^2;
% A(4,2) = (mu + x - 1)*((3*mu*y)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) - (3*J2s*Rs^2*mu*y)/((mu + x - 1)^2 + y^2 + z^2)^(7/2) + (21*J2s*Rs^2*mu*y*((mu + x - 1)^2 + y^2 - 4*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(9/2))) - (mu + x)*((3*y*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2) - (J2p*Rp^2*y*(3*mu - 3))/((mu + x)^2 + y^2 + z^2)^(7/2) + (7*J2p*Rp^2*y*(3*mu - 3)*((mu + x)^2 + y^2 - 4*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(9/2)));
% A(4,3) = (mu + x - 1)*((3*mu*z)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) + (12*J2s*Rs^2*mu*z)/((mu + x - 1)^2 + y^2 + z^2)^(7/2) + (21*J2s*Rs^2*mu*z*((mu + x - 1)^2 + y^2 - 4*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(9/2))) - (mu + x)*((3*z*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2) + (4*J2p*Rp^2*z*(3*mu - 3))/((mu + x)^2 + y^2 + z^2)^(7/2) + (7*J2p*Rp^2*z*(3*mu - 3)*((mu + x)^2 + y^2 - 4*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(9/2)));
% A(5,1) = -y*((3*(2*mu + 2*x)*(mu - 1))/(2*((mu + x)^2 + y^2 + z^2)^(5/2)) - (3*mu*(2*mu + 2*x - 2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(5/2)) - (J2p*Rp^2*(2*mu + 2*x)*(3*mu - 3))/(2*((mu + x)^2 + y^2 + z^2)^(7/2)) + (3*J2s*Rs^2*mu*(2*mu + 2*x - 2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(7/2)) - (21*J2s*Rs^2*mu*(2*mu + 2*x - 2)*((mu + x - 1)^2 + y^2 - 4*z^2))/(4*((mu + x - 1)^2 + y^2 + z^2)^(9/2)) + (7*J2p*Rp^2*(2*mu + 2*x)*(3*mu - 3)*((mu + x)^2 + y^2 - 4*z^2))/(4*((mu + x)^2 + y^2 + z^2)^(9/2)));
% A(5,2) = (mu - 1)/((mu + x)^2 + y^2 + z^2)^(3/2) + y*((3*mu*y)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) - (3*y*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2) + (J2p*Rp^2*y*(3*mu - 3))/((mu + x)^2 + y^2 + z^2)^(7/2) - (3*J2s*Rs^2*mu*y)/((mu + x - 1)^2 + y^2 + z^2)^(7/2) - (7*J2p*Rp^2*y*(3*mu - 3)*((mu + x)^2 + y^2 - 4*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(9/2)) + (21*J2s*Rs^2*mu*y*((mu + x - 1)^2 + y^2 - 4*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(9/2))) - mu/((mu + x - 1)^2 + y^2 + z^2)^(3/2) - (3*J2s*Rs^2*mu*((mu + x - 1)^2 + y^2 - 4*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(7/2)) + (J2p*Rp^2*(3*mu - 3)*((mu + x)^2 + y^2 - 4*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(7/2)) + n^2;
% A(5,3) = y*((3*mu*z)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) - (3*z*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2) - (4*J2p*Rp^2*z*(3*mu - 3))/((mu + x)^2 + y^2 + z^2)^(7/2) + (12*J2s*Rs^2*mu*z)/((mu + x - 1)^2 + y^2 + z^2)^(7/2) - (7*J2p*Rp^2*z*(3*mu - 3)*((mu + x)^2 + y^2 - 4*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(9/2)) + (21*J2s*Rs^2*mu*z*((mu + x - 1)^2 + y^2 - 4*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(9/2)));
% A(6,1) = -z*((3*(2*mu + 2*x)*(mu - 1))/(2*((mu + x)^2 + y^2 + z^2)^(5/2)) - (3*mu*(2*mu + 2*x - 2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(5/2)) - (J2p*Rp^2*(6*mu + 6*x)*(3*mu - 3))/(2*((mu + x)^2 + y^2 + z^2)^(7/2)) + (3*J2s*Rs^2*mu*(6*mu + 6*x - 6))/(2*((mu + x - 1)^2 + y^2 + z^2)^(7/2)) + (7*J2p*Rp^2*(2*mu + 2*x)*(3*mu - 3)*(3*(mu + x)^2 + 3*y^2 - 2*z^2))/(4*((mu + x)^2 + y^2 + z^2)^(9/2)) - (21*J2s*Rs^2*mu*(2*mu + 2*x - 2)*(3*(mu + x - 1)^2 + 3*y^2 - 2*z^2))/(4*((mu + x - 1)^2 + y^2 + z^2)^(9/2)));
% A(6,2) = z*((3*mu*y)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) - (3*y*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2) + (3*J2p*Rp^2*y*(3*mu - 3))/((mu + x)^2 + y^2 + z^2)^(7/2) - (9*J2s*Rs^2*mu*y)/((mu + x - 1)^2 + y^2 + z^2)^(7/2) + (21*J2s*Rs^2*mu*y*(3*(mu + x - 1)^2 + 3*y^2 - 2*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(9/2)) - (7*J2p*Rp^2*y*(3*mu - 3)*(3*(mu + x)^2 + 3*y^2 - 2*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(9/2)));
% A(6,3) = z*((3*mu*z)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) - (3*z*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2) - (2*J2p*Rp^2*z*(3*mu - 3))/((mu + x)^2 + y^2 + z^2)^(7/2) + (6*J2s*Rs^2*mu*z)/((mu + x - 1)^2 + y^2 + z^2)^(7/2) - (7*J2p*Rp^2*z*(3*mu - 3)*(3*(mu + x)^2 + 3*y^2 - 2*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(9/2)) + (21*J2s*Rs^2*mu*z*(3*(mu + x - 1)^2 + 3*y^2 - 2*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(9/2))) + (mu - 1)/((mu + x)^2 + y^2 + z^2)^(3/2) - mu/((mu + x - 1)^2 + y^2 + z^2)^(3/2) + (J2p*Rp^2*(3*mu - 3)*(3*(mu + x)^2 + 3*y^2 - 2*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(7/2)) - (3*J2s*Rs^2*mu*(3*(mu + x - 1)^2 + 3*y^2 - 2*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(7/2));

A = zeros(6,6);
A(1:3,4:6) = eye(3);
A(4,5) = 2*n;
A(5,4) = -2*n;
A(4,1) = (mu - 1)/((mu + x)^2 + y^2 + z^2)^(3/2) + n^2 - mu/((mu + x - 1)^2 + y^2 + z^2)^(3/2) + (3*mu*(2*mu + 2*x - 2)^2)/(4*((mu + x - 1)^2 + y^2 + z^2)^(5/2)) - (3*(2*mu + 2*x)^2*(mu - 1))/(4*((mu + x)^2 + y^2 + z^2)^(5/2)) - (J2p*Rp^2*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2) + (J2s*Rs^2*mu)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) - (5*J2s*Rs^2*mu*((mu + x - 1)^2 + y^2 - 2*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(7/2)) - (5*J2s*Rs^2*mu*(2*mu + 2*x - 2)^2)/(2*((mu + x - 1)^2 + y^2 + z^2)^(7/2)) + (5*J2p*Rp^2*(mu - 1)*((mu + x)^2 + y^2 - 2*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(7/2)) + (5*J2p*Rp^2*(2*mu + 2*x)^2*(mu - 1))/(2*((mu + x)^2 + y^2 + z^2)^(7/2)) + (35*J2s*Rs^2*mu*(2*mu + 2*x - 2)^2*((mu + x - 1)^2 + y^2 - 2*z^2))/(8*((mu + x - 1)^2 + y^2 + z^2)^(9/2)) - (35*J2p*Rp^2*(2*mu + 2*x)^2*(mu - 1)*((mu + x)^2 + y^2 - 2*z^2))/(8*((mu + x)^2 + y^2 + z^2)^(9/2));
A(4,2) = (3*mu*y*(2*mu + 2*x - 2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(5/2)) - (3*y*(2*mu + 2*x)*(mu - 1))/(2*((mu + x)^2 + y^2 + z^2)^(5/2)) - (5*J2s*Rs^2*mu*y*(2*mu + 2*x - 2))/((mu + x - 1)^2 + y^2 + z^2)^(7/2) + (5*J2p*Rp^2*y*(2*mu + 2*x)*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(7/2) + (35*J2s*Rs^2*mu*y*(2*mu + 2*x - 2)*((mu + x - 1)^2 + y^2 - 2*z^2))/(4*((mu + x - 1)^2 + y^2 + z^2)^(9/2)) - (35*J2p*Rp^2*y*(2*mu + 2*x)*(mu - 1)*((mu + x)^2 + y^2 - 2*z^2))/(4*((mu + x)^2 + y^2 + z^2)^(9/2));
A(4,3) = (3*mu*z*(2*mu + 2*x - 2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(5/2)) - (3*z*(2*mu + 2*x)*(mu - 1))/(2*((mu + x)^2 + y^2 + z^2)^(5/2)) + (5*J2s*Rs^2*mu*z*(2*mu + 2*x - 2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(7/2)) - (5*J2p*Rp^2*z*(2*mu + 2*x)*(mu - 1))/(2*((mu + x)^2 + y^2 + z^2)^(7/2)) + (35*J2s*Rs^2*mu*z*(2*mu + 2*x - 2)*((mu + x - 1)^2 + y^2 - 2*z^2))/(4*((mu + x - 1)^2 + y^2 + z^2)^(9/2)) - (35*J2p*Rp^2*z*(2*mu + 2*x)*(mu - 1)*((mu + x)^2 + y^2 - 2*z^2))/(4*((mu + x)^2 + y^2 + z^2)^(9/2));
A(5,1) = (3*mu*y*(2*mu + 2*x - 2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(5/2)) - (3*y*(2*mu + 2*x)*(mu - 1))/(2*((mu + x)^2 + y^2 + z^2)^(5/2)) - (5*J2s*Rs^2*mu*y*(2*mu + 2*x - 2))/((mu + x - 1)^2 + y^2 + z^2)^(7/2) + (5*J2p*Rp^2*y*(2*mu + 2*x)*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(7/2) + (35*J2s*Rs^2*mu*y*(2*mu + 2*x - 2)*((mu + x - 1)^2 + y^2 - 2*z^2))/(4*((mu + x - 1)^2 + y^2 + z^2)^(9/2)) - (35*J2p*Rp^2*y*(2*mu + 2*x)*(mu - 1)*((mu + x)^2 + y^2 - 2*z^2))/(4*((mu + x)^2 + y^2 + z^2)^(9/2));
A(5,2) = (mu - 1)/((mu + x)^2 + y^2 + z^2)^(3/2) + n^2 - mu/((mu + x - 1)^2 + y^2 + z^2)^(3/2) - (3*y^2*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2) + (3*mu*y^2)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) - (J2p*Rp^2*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2) + (J2s*Rs^2*mu)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) - (5*J2s*Rs^2*mu*((mu + x - 1)^2 + y^2 - 2*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(7/2)) + (10*J2p*Rp^2*y^2*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(7/2) + (5*J2p*Rp^2*(mu - 1)*((mu + x)^2 + y^2 - 2*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(7/2)) - (10*J2s*Rs^2*mu*y^2)/((mu + x - 1)^2 + y^2 + z^2)^(7/2) - (35*J2p*Rp^2*y^2*(mu - 1)*((mu + x)^2 + y^2 - 2*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(9/2)) + (35*J2s*Rs^2*mu*y^2*((mu + x - 1)^2 + y^2 - 2*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(9/2));
A(5,3) = (3*mu*y*z)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) - (3*y*z*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2) - (5*J2p*Rp^2*y*z*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(7/2) + (5*J2s*Rs^2*mu*y*z)/((mu + x - 1)^2 + y^2 + z^2)^(7/2) - (35*J2p*Rp^2*y*z*(mu - 1)*((mu + x)^2 + y^2 - 2*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(9/2)) + (35*J2s*Rs^2*mu*y*z*((mu + x - 1)^2 + y^2 - 2*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(9/2));
A(6,1) = (3*mu*z*(2*mu + 2*x - 2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(5/2)) - (3*z*(2*mu + 2*x)*(mu - 1))/(2*((mu + x)^2 + y^2 + z^2)^(5/2)) + (5*J2s*Rs^2*mu*z*(2*mu + 2*x - 2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(7/2)) - (5*J2p*Rp^2*z*(2*mu + 2*x)*(mu - 1))/(2*((mu + x)^2 + y^2 + z^2)^(7/2)) + (35*J2s*Rs^2*mu*z*(2*mu + 2*x - 2)*((mu + x - 1)^2 + y^2 - 2*z^2))/(4*((mu + x - 1)^2 + y^2 + z^2)^(9/2)) - (35*J2p*Rp^2*z*(2*mu + 2*x)*(mu - 1)*((mu + x)^2 + y^2 - 2*z^2))/(4*((mu + x)^2 + y^2 + z^2)^(9/2));
A(6,2) = (3*mu*y*z)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) - (3*y*z*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2) - (5*J2p*Rp^2*y*z*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(7/2) + (5*J2s*Rs^2*mu*y*z)/((mu + x - 1)^2 + y^2 + z^2)^(7/2) - (35*J2p*Rp^2*y*z*(mu - 1)*((mu + x)^2 + y^2 - 2*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(9/2)) + (35*J2s*Rs^2*mu*y*z*((mu + x - 1)^2 + y^2 - 2*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(9/2));
A(6,3) = (mu - 1)/((mu + x)^2 + y^2 + z^2)^(3/2) - mu/((mu + x - 1)^2 + y^2 + z^2)^(3/2) - (3*z^2*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2) + (3*mu*z^2)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) + (2*J2p*Rp^2*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2) - (2*J2s*Rs^2*mu)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) - (5*J2s*Rs^2*mu*((mu + x - 1)^2 + y^2 - 2*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(7/2)) - (20*J2p*Rp^2*z^2*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(7/2) + (5*J2p*Rp^2*(mu - 1)*((mu + x)^2 + y^2 - 2*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(7/2)) + (20*J2s*Rs^2*mu*z^2)/((mu + x - 1)^2 + y^2 + z^2)^(7/2) - (35*J2p*Rp^2*z^2*(mu - 1)*((mu + x)^2 + y^2 - 2*z^2))/(2*((mu + x)^2 + y^2 + z^2)^(9/2)) + (35*J2s*Rs^2*mu*z^2*((mu + x - 1)^2 + y^2 - 2*z^2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(9/2));


end

