function [A] = get_Amat_CR3BP(u, x, y, z)
%%% Returns the A-matrix for the CR3BP

% %%% Lower-Left [3x3] of A matrix
% A_LL = @(u,x,y,z)...
%     [(u - 1)/((u + x)^2 + y^2 + z^2)^(3/2) - u/((u + x - 1)^2 + y^2 + z^2)^(3/2) + (3*u*(2*u + 2*x - 2)*(u + x - 1))/(2*((u + x - 1)^2 + y^2 + z^2)^(5/2)) - (3*(2*u + 2*x)*(u + x)*(u - 1))/(2*((u + x)^2 + y^2 + z^2)^(5/2)) + 1,...
%     (3*u*y*(u + x - 1))/((u + x - 1)^2 + y^2 + z^2)^(5/2) - (3*y*(u + x)*(u - 1))/((u + x)^2 + y^2 + z^2)^(5/2),...
%     (3*u*z*(u + x - 1))/((u + x - 1)^2 + y^2 + z^2)^(5/2) - (3*z*(u + x)*(u - 1))/((u + x)^2 + y^2 + z^2)^(5/2);...
%     -y*((3*(2*u + 2*x)*(u - 1))/(2*((u + x)^2 + y^2 + z^2)^(5/2)) - (3*u*(2*u + 2*x - 2))/(2*((u + x - 1)^2 + y^2 + z^2)^(5/2))),...
%     (u - 1)/((u + x)^2 + y^2 + z^2)^(3/2) + y*((3*u*y)/((u + x - 1)^2 + y^2 + z^2)^(5/2) - (3*y*(u - 1))/((u + x)^2 + y^2 + z^2)^(5/2)) - u/((u + x - 1)^2 + y^2 + z^2)^(3/2) + 1,...
%     y*((3*u*z)/((u + x - 1)^2 + y^2 + z^2)^(5/2) - (3*z*(u - 1))/((u + x)^2 + y^2 + z^2)^(5/2));...
%     -z*((3*(2*u + 2*x)*(u - 1))/(2*((u + x)^2 + y^2 + z^2)^(5/2)) - (3*u*(2*u + 2*x - 2))/(2*((u + x - 1)^2 + y^2 + z^2)^(5/2))),...
%     z*((3*u*y)/((u + x - 1)^2 + y^2 + z^2)^(5/2) - (3*y*(u - 1))/((u + x)^2 + y^2 + z^2)^(5/2)),...
%     (u - 1)/((u + x)^2 + y^2 + z^2)^(3/2) + z*((3*u*z)/((u + x - 1)^2 + y^2 + z^2)^(5/2) - (3*z*(u - 1))/((u + x)^2 + y^2 + z^2)^(5/2)) - u/((u + x - 1)^2 + y^2 + z^2)^(3/2)];
% 
% %%% Full A matrix
% Amat = @(u, x, y, z) ...
%     [zeros(3,3),     eye(3);...
%      A_LL(u,x,y,z), [0,2,0;-2,0,0;0,0,0]];
%  
% %%% Computing A matrix
% A = Amat(u,x,y,z);

A = zeros(6,6);
A(1:3,4:6) = eye(3);
A(4,5) = 2;
A(5,4) = -2;
A(4,1) = (u - 1)/((u + x)^2 + y^2 + z^2)^(3/2) - u/((u + x - 1)^2 + y^2 + z^2)^(3/2) + (3*u*(2*u + 2*x - 2)*(u + x - 1))/(2*((u + x - 1)^2 + y^2 + z^2)^(5/2)) - (3*(2*u + 2*x)*(u + x)*(u - 1))/(2*((u + x)^2 + y^2 + z^2)^(5/2)) + 1;
A(4,2) = (3*u*y*(u + x - 1))/((u + x - 1)^2 + y^2 + z^2)^(5/2) - (3*y*(u + x)*(u - 1))/((u + x)^2 + y^2 + z^2)^(5/2);
A(4,3) = (3*u*z*(u + x - 1))/((u + x - 1)^2 + y^2 + z^2)^(5/2) - (3*z*(u + x)*(u - 1))/((u + x)^2 + y^2 + z^2)^(5/2);
A(5,1) = -y*((3*(2*u + 2*x)*(u - 1))/(2*((u + x)^2 + y^2 + z^2)^(5/2)) - (3*u*(2*u + 2*x - 2))/(2*((u + x - 1)^2 + y^2 + z^2)^(5/2)));
A(5,2) = (u - 1)/((u + x)^2 + y^2 + z^2)^(3/2) + y*((3*u*y)/((u + x - 1)^2 + y^2 + z^2)^(5/2) - (3*y*(u - 1))/((u + x)^2 + y^2 + z^2)^(5/2)) - u/((u + x - 1)^2 + y^2 + z^2)^(3/2) + 1;
A(5,3) = y*((3*u*z)/((u + x - 1)^2 + y^2 + z^2)^(5/2) - (3*z*(u - 1))/((u + x)^2 + y^2 + z^2)^(5/2));
A(6,1) = -z*((3*(2*u + 2*x)*(u - 1))/(2*((u + x)^2 + y^2 + z^2)^(5/2)) - (3*u*(2*u + 2*x - 2))/(2*((u + x - 1)^2 + y^2 + z^2)^(5/2)));
A(6,2) = z*((3*u*y)/((u + x - 1)^2 + y^2 + z^2)^(5/2) - (3*y*(u - 1))/((u + x)^2 + y^2 + z^2)^(5/2));
A(6,3) = (u - 1)/((u + x)^2 + y^2 + z^2)^(3/2) + z*((3*u*z)/((u + x - 1)^2 + y^2 + z^2)^(5/2) - (3*z*(u - 1))/((u + x)^2 + y^2 + z^2)^(5/2)) - u/((u + x - 1)^2 + y^2 + z^2)^(3/2);

end

